// https://www.npmjs.com/package/@dalian/line-chart v0.0.1 Copyright 2019 Enys Mones
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@dalian/chart"),require("d3-selection"),require("d3-shape"),require("d3-array"),require("@dalian/widget")):"function"==typeof define&&define.amd?define(["@dalian/chart","d3-selection","d3-shape","d3-array","@dalian/widget"],e):(t=t||self).LineChart=e(t.chart,t.d3,t.d3,t.d3,t.Widget)}(this,function(t,e,a,s,i){"use strict";i=i&&i.hasOwnProperty("default")?i.default:i;class n extends t.Chart{constructor(e,a){super("line",e,a),this._attr.range={x:{min:null,max:null}},this._attr.labels={x:"",y:""},this._attr.lineStyles={policy:null,mapping:()=>null},this._attr.smooth=!1,this._dom.scales={x:new t.Scale("linear"),y:new t.Scale("linear")},this._dom.axes=new t.Axes(this._dom),this._dom.paths=new Map}xLabel(t){return this._attr.labels.x=t,this}yLabel(t){return this._attr.labels.y=t,this}lineStyles(t=null){return this._attr.lineStyles.policy=t,this._attr.lineStyles.mapping=null===t?()=>null:"string"==typeof t?()=>{switch(t){default:case"solid":return null;case"dashed":return"4 4";case"dotted":return"2 5"}}:e=>{switch(t[e]){default:case"solid":return null;case"dashed":return"4 4";case"dotted":return"2 5"}},this}smooth(t=!1){return this._attr.smooth=t,this}highlight(t,e=400){return this._highlight(".line",t,e),this._highlight(".error",t,e),this._highlight(".tooltip-marker",t,e),this}_transformData(t){return t.map(function(t){return{name:t.name,values:t.values.sort(function(t,e){return t.x-e.x}).map(function(t){return{x:t.x,y:t.y,lo:t.lo||0,hi:t.hi||0}})}})}_chartUpdate(){let t=this._data.reduce((t,e)=>t.concat(e.values),[]),s=t.map(t=>t.y),n=Math.min(...s),r=Math.max(...s);this._dom.scales.x.update(t.map(t=>t.x),[0,parseInt(this._attr.size.innerWidth)]),this._dom.scales.y.update(t.map(t=>t.y),[parseInt(this._attr.size.innerHeight),0]),this._dom.axes.update(this._attr,this._dom.scales);const l=a.line().x(t=>this._dom.scales.x.scale(t.x)+2).y(t=>this._dom.scales.y.scale(t.y)).curve(this._attr.smooth?a.curveMonotoneX:a.curveLinear),o=a.area().x(t=>this._dom.scales.x.scale(t.x)+2).y0(t=>this._dom.scales.y.scale(Math.max(n,t.y-t.lo))).y1(t=>this._dom.scales.y.scale(Math.min(r,t.y+t.hi))).curve(this._attr.smooth?a.curveMonotoneX:a.curveLinear);this._plotGroups(this._dom.plots,{enter:t=>(t.append("path").attr("class",t=>`error ${i.encode(t.name)}`).attr("d",t=>o(t.values)).style("stroke","none").style("fill-opacity",.2),t.append("path").attr("class",t=>`line ${i.encode(t.name)}`).attr("d",t=>l(t.values)).style("stroke-width","2px").style("stroke-dasharray",t=>this._attr.lineStyles.mapping(t.name)).style("fill","none").each(t=>{this._dom.paths.set(t.name,e.select(`.line.${i.encode(t.name)}`).node())}),t),union:{after:t=>(t.select(".line").attr("d",t=>l(t.values)),t.select(".error").attr("d",t=>o(t.values)),t)}})}static findY(t,e){if(void 0===t)return;let a=t.getTotalLength(),s=0,i=a,n=(s+i)/2;for(e=Math.max(e,t.getPointAtLength(0).x),e=Math.min(e,t.getPointAtLength(a).x);n>=s&&n<=a;){let a=t.getPointAtLength(n);if(Math.abs(a.x-e)<.01)return a.y;a.x>e?i=n:s=n,n=(s+i)/2}}_createTooltipContent(t){let e,a=s.bisector(t=>this._dom.scales.x.scale(t.x)).left,r=t?this._data.map(e=>a(e.values,t[0])):null;if(null===r){for(let t in this.tt)this.tt.hasOwnProperty(t)&&this.tt[t].remove();return void(this.tt=null)}this.tt=this.tt||{},e=this.tt;let l=this._dom.scales.x.scale.invert(t[0]),o=this._data.map((a,s)=>{let o=r[s],h=a.values,d=h[o-1]?h[o-1]:h[o],c=h[o]?h[o]:h[o-1],u=l-d.x>c.x-l?c:d;l=u.x;let m=n.findY(this._dom.paths.get(a.name),t[0]);return"number"==typeof m&&(e[a.name]=e[a.name]||this._dom.plots.append("circle"),e[a.name].attr("class",`tooltip-marker ${i.encode(a.name)}`).attr("cx",t[0]).attr("cy",m).attr("r",4).style("fill",this._attr.colors.mapping(a.name)).style("pointer-events","none")),{name:a.name,color:this._attr.colors.mapping(a.name),dashed:!!this._attr.lineStyles.mapping(a.name)||void 0,value:u.y}});return{title:l,content:{type:"plots",data:o}}}}return n});
