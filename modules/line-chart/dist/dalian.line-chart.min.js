// https://www.npmjs.com/package/@dalian/line-chart v0.0.1 Copyright 2019 Enys Mones
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@dalian/chart"),require("d3-selection"),require("d3-shape"),require("d3-array"),require("@dalian/widget")):"function"==typeof define&&define.amd?define(["@dalian/chart","d3-selection","d3-shape","d3-array","@dalian/widget"],e):(t=t||self).LineChart=e(t.chart,t.d3,t.d3,t.d3,t.Widget)}(this,function(t,e,a,s,i){"use strict";i=i&&i.hasOwnProperty("default")?i.default:i;return class extends t.Chart{constructor(e,a){super("line",e,a),this._attr.range={x:{min:null,max:null}},this._attr.labels={x:"",y:""},this._attr.lineStyles={policy:null,mapping:()=>null},this._dom.scales={x:new t.Scale("linear"),y:new t.Scale("linear")},this._dom.axes=new t.Axes(this._dom),this._dom.paths=new Map}xLabel(t){return this._attr.labels.x=t,this}yLabel(t){return this._attr.labels.y=t,this}lineStyles(t=null){return this._attr.lineStyles.policy=t,this._attr.lineStyles.mapping=null===t?()=>null:"string"==typeof t?()=>{switch(t){default:case"solid":return null;case"dashed":return"4 4";case"dotted":return"2 5"}}:e=>{switch(t[e]){default:case"solid":return null;case"dashed":return"4 4";case"dotted":return"2 5"}},this}highlight(t,e){this._highlight(".line",t,e),this._highlight(".error",t,e)}_transformData(t){return t.map(function(t){return{name:t.name,values:t.values.sort(function(t,e){return t.x-e.x}).map(function(t){return{x:t.x,y:t.y,lo:t.lo||0,hi:t.hi||0}})}})}_chartUpdate(){let t=this._data.reduce((t,e)=>t.concat(e.values),[]),s=t.map(t=>t.y),l=Math.min(...s),n=Math.max(...s);this._dom.scales.x.update(t.map(t=>t.x),[0,parseInt(this._attr.size.innerWidth)]),this._dom.scales.y.update(t.map(t=>t.y),[parseInt(this._attr.size.innerHeight),0]),this._dom.axes.update(this._attr,this._dom.scales);const r=a.line().x(t=>this._dom.scales.x.scale(t.x)+2).y(t=>this._dom.scales.y.scale(t.y)),h=a.area().x(t=>this._dom.scales.x.scale(t.x)+2).y0(t=>this._dom.scales.y.scale(Math.max(l,t.y-t.lo))).y1(t=>this._dom.scales.y.scale(Math.min(n,t.y+t.hi)));this._plotGroups(this._dom.plots,{enter:t=>(t.append("path").attr("class",t=>`error ${i.encode(t.name)}`).attr("d",t=>h(t.values)).style("stroke","none").style("fill-opacity",.2),t.append("path").attr("class",t=>`line ${i.encode(t.name)}`).attr("d",t=>r(t.values)).style("stroke-width","2px").style("stroke-dasharray",t=>this._attr.lineStyles.mapping(t.name)).style("fill","none").each(t=>{this._dom.paths.set(t.name,e.select(`.${i.encode(t.name)}`).node())}),t),union:{after:t=>(t.select(".line").attr("d",t=>r(t.values)),t.select(".error").attr("d",t=>h(t.values)),t)}})}static findY(t,e){if(void 0===t)return;console.log(t);let a=t.getTotalLength(),s=0,i=a,l=(s+i)/2;for(e=Math.max(e,t.getPointAtLength(0).x),e=Math.min(e,t.getPointAtLength(a).x);l>=s&&l<=a;){let a=t.getPointAtLength(l);if(Math.abs(a.x-e)<1e-4)return a.y;a.x>e?i=l:s=l,l=(s+i)/2}}_chartTooltipContent(t){let e,a=s.bisector(t=>this._dom.scales.x.scale(t.x)).left,i=t?this._data.map(e=>a(e.values,t[0])):null;if(null===i){for(let t in this.tt)this.tt.hasOwnProperty(t)&&this.tt[t].remove();return void(this.tt=null)}this.tt=this.tt||{},e=this.tt;let l=this._dom.scales.x.scale.invert(t[0]),n=this._data.map((t,e)=>{let a=i[e],s=t.values,n=s[a-1]?s[a-1]:s[a],r=s[a]?s[a]:s[a-1],h=l-n.x>r.x-l?r:n;return l=h.x,{name:t.name,color:this._attr.colors.mapping(t.name),dashed:!!this._attr.lineStyles.mapping(t.name)||void 0,value:h.y}});return{title:l,content:{type:"plots",data:n}}}}});
