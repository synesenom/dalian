// https://www.npmjs.com/package/@dalian/line-chart v0.0.1 Copyright 2019 Enys Mones
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@dalian/chart"),require("d3-selection"),require("d3-shape"),require("d3-array"),require("@dalian/widget")):"function"==typeof define&&define.amd?define(["@dalian/chart","d3-selection","d3-shape","d3-array","@dalian/widget"],e):(t=t||self).LineChart=e(t.chart,t.d3,t.d3,t.d3,t.Widget)}(this,function(t,e,s,a,r){"use strict";r=r&&r.hasOwnProperty("default")?r.default:r;class l extends t.Chart{constructor(e,s){super("line",e,s),this._attr.lineStyles={policy:null,mapping:()=>null},this._attr.smooth=!1,this._dom.scales={x:new t.Scale("linear"),y:new t.Scale("linear")},this._dom.axes=new t.Axes(this._dom),this._dom.paths=new Map,this._dom.markers=new Map}lineStyles(t=null){return this._attr.lineStyles.policy=t,this._attr.lineStyles.mapping=null===t?()=>null:"string"==typeof t?()=>{switch(t){default:case"solid":return null;case"dashed":return"4 4";case"dotted":return"2 5"}}:e=>{switch(t[e]){default:case"solid":return null;case"dashed":return"4 4";case"dotted":return"2 5"}},this}smooth(t=!1){return this._attr.smooth=t,this}highlight(t,e=400){return this._highlight(".line",t,e),this._highlight(".error",t,e),this._highlight(".tooltip-marker",t,e),this._highlight(".marker",t,e),this}_adjustMarker(t,e,s){let r=this._data.filter(e=>e.name===t)[0];if(!r)return null;let l=a.bisector(t=>t.x).left,i=l(r.values,e),n=l(r.values,s);if(null===i||null===n)return null;let o=r.values[i].x,c=r.values[i].y,h=r.values[n].x,d=r.values[n].y;return{start:{x:o,y:c},end:{x:h,y:d},corner:{x:c<d?o:h,y:c<d?d:c}}}addMarker(t,e,s,a,l){if(this._dom.markers.has(t))return null;let i=this._adjustMarker(e,s,a),n=this._dom.plots.append("g").attr("class","marker "+r.encode(e));n.append("line").attr("class","horizontal").attr("x1",this._dom.scales.x.scale(Math.max(i.start.x,i.start.x))+2).attr("y1",this._dom.scales.y.scale(i.corner.y)).attr("x2",this._dom.scales.x.scale(Math.min(i.end.x,i.end.x))+2).attr("y2",this._dom.scales.y.scale(i.corner.y)).style("stroke",this._attr.colors.mapping(e)).style("stroke-dasharray","3 3").style("stroke-width",1),n.append("line").attr("class","vertical").attr("x1",this._dom.scales.x.scale(i.corner.x)+2).attr("y1",this._dom.scales.y.scale(i.start.y)).attr("x2",this._dom.scales.x.scale(i.corner.x)+2).attr("y2",this._dom.scales.y.scale(i.end.y)).style("stroke",this._attr.colors.mapping(e)).style("stroke-dasharray","3 3").style("stroke-width",1),n.append("circle").attr("class","start").attr("cx",this._dom.scales.x.scale(i.start.x)+2).attr("cy",this._dom.scales.y.scale(i.start.y)).attr("r",4).style("stroke","none").style("fill",this._attr.colors.mapping(e)),n.append("circle").attr("class","end").attr("cx",this._dom.scales.x.scale(i.end.x)+2).attr("cy",this._dom.scales.y.scale(i.end.y)).attr("r",4).style("stroke","none").style("fill",this._attr.colors.mapping(e)),n.append("text").attr("x",this._dom.scales.x.scale(i.corner.x)+2).attr("y",this._dom.scales.y.scale(i.corner.y)).attr("dy",-5).attr("text-anchor",i.start.y<i.end.y?"start":"end").style("fill",this._attr.font.color).style("font-family","inherit").style("font-size","0.9em").text(l);let o={key:e,g:n,update:t=>{let r=this._adjustMarker(e,s,a);n.select(".horizontal").transition().duration(t).attr("x1",this._dom.scales.x.scale(Math.max(r.start.x,r.start.x))+2).attr("y1",this._dom.scales.y.scale(r.corner.y)).attr("x2",this._dom.scales.x.scale(Math.min(r.end.x,r.end.x))+2).attr("y2",this._dom.scales.y.scale(r.corner.y)).style("stroke",this._attr.colors.mapping(e)),n.select(".vertical").transition().duration(t).attr("x1",this._dom.scales.x.scale(r.corner.x)+2).attr("y1",this._dom.scales.y.scale(r.start.y)).attr("x2",this._dom.scales.x.scale(r.corner.x)+2).attr("y2",this._dom.scales.y.scale(r.end.y)).style("stroke",this._attr.colors.mapping(e)),n.select(".start").transition().duration(t).attr("cx",this._dom.scales.x.scale(r.start.x)+2).attr("cy",this._dom.scales.y.scale(r.start.y)).style("fill",this._attr.colors.mapping(e)),n.select(".end").transition().duration(t).attr("cx",this._dom.scales.x.scale(r.end.x)+2).attr("cy",this._dom.scales.y.scale(r.end.y)).style("fill",this._attr.colors.mapping(e)),n.select("text").transition().duration(t).attr("x",this._dom.scales.x.scale(r.corner.x)+2).attr("y",this._dom.scales.y.scale(r.corner.y)).attr("text-anchor",r.start.y<r.end.y?"start":"end").style("fill",this._attr.font.color)}};return this._dom.markers.set(t,o),o}removeMarker(t){return!!this._dom.markers.has(t)&&(this._dom.markers.get(t).g.remove(),this._dom.markers.delete(t),!0)}_transformData(t){return t.map(function(t){return{name:t.name,values:t.values.sort(function(t,e){return t.x-e.x}).map(function(t){return{x:t.x,y:t.y,lo:t.lo||0,hi:t.hi||0}})}})}_chartUpdate(){let t=this._data.reduce((t,e)=>t.concat(e.values),[]),a=t.map(t=>t.y),l=Math.min(...a),i=Math.max(...a);this._dom.scales.x.update(t.map(t=>t.x),[0,parseInt(this._attr.size.innerWidth)]),this._dom.scales.y.update(t.map(t=>t.y),[parseInt(this._attr.size.innerHeight),0]),this._dom.axes.update(this._attr,this._dom.scales);const n=s.line().x(t=>this._dom.scales.x.scale(t.x)+2).y(t=>this._dom.scales.y.scale(t.y)).curve(this._attr.smooth?s.curveMonotoneX:s.curveLinear),o=s.area().x(t=>this._dom.scales.x.scale(t.x)+2).y0(t=>this._dom.scales.y.scale(Math.max(l,t.y-t.lo))).y1(t=>this._dom.scales.y.scale(Math.min(i,t.y+t.hi))).curve(this._attr.smooth?s.curveMonotoneX:s.curveLinear);this._plotGroups(this._dom.plots,{enter:t=>(t.append("path").attr("class",t=>`error ${r.encode(t.name)}`).attr("d",t=>o(t.values)).style("stroke","none").style("fill-opacity",.2),t.append("path").attr("class",t=>`line ${r.encode(t.name)}`).attr("d",t=>n(t.values)).style("stroke-width","2px").style("stroke-dasharray",t=>this._attr.lineStyles.mapping(t.name)).style("fill","none").each(t=>{this._dom.paths.set(t.name,e.select(`.line.${r.encode(t.name)}`).node())}),t),union:{after:t=>(t.select(".line").attr("d",t=>n(t.values)),t.select(".error").attr("d",t=>o(t.values)),t)}}),this._dom.markers.forEach(t=>{t.update(700)})}static findY(t,e){if(void 0===t)return;let s=t.getTotalLength(),a=0,r=s,l=(a+r)/2;for(e=Math.max(e,t.getPointAtLength(0).x),e=Math.min(e,t.getPointAtLength(s).x);l>=a&&l<=s;){let s=t.getPointAtLength(l);if(Math.abs(s.x-e)<.01)return s.y;s.x>e?r=l:a=l,l=(a+r)/2}}_createTooltipContent(t){let e,s=a.bisector(t=>this._dom.scales.x.scale(t.x)).left,i=t?this._data.map(e=>s(e.values,t[0])):null;if(null===i){for(let t in this.tt)this.tt.hasOwnProperty(t)&&this.tt[t].remove();return void(this.tt=null)}this.tt=this.tt||{},e=this.tt;let n=this._dom.scales.x.scale.invert(t[0]),o=this._data.map((s,a)=>{let o=i[a],c=s.values,h=c[o-1]?c[o-1]:c[o],d=c[o]?c[o]:c[o-1],m=n-h.x>d.x-n?d:h;n=m.x;let y=l.findY(this._dom.paths.get(s.name),t[0]);return"number"==typeof y&&(e[s.name]=e[s.name]||this._dom.plots.append("circle"),e[s.name].attr("class",`tooltip-marker ${r.encode(s.name)}`).attr("cx",t[0]).attr("cy",y).attr("r",4).style("fill",this._attr.colors.mapping(s.name)).style("pointer-events","none")),{name:s.name,color:this._attr.colors.mapping(s.name),dashed:!!this._attr.lineStyles.mapping(s.name)||void 0,value:m.y}});return{title:n,content:{type:"plots",data:o}}}}return l});
